<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividades y Calificaciones</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .actividades-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .actividades-list {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .actividad-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1));
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .actividad-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-gold);
            box-shadow: 0 8px 30px rgba(251, 191, 36, 0.3);
        }

        .actividad-card.selected {
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
            box-shadow: 0 8px 30px rgba(251, 191, 36, 0.3);
        }

        .actividad-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .actividad-titulo {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .actividad-puntos {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-gold-dark));
            color: #1f2937;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 0.9rem;
        }

        .actividad-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .calificacion-section {
            background: rgba(31, 41, 55, 0.5);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 25px;
            margin-top: 30px;
            display: none;
        }

        .calificacion-section.active {
            display: block;
        }

        .grilla-header {
            display: grid;
            grid-template-columns: 50px 1fr 150px 200px 150px;
            gap: 15px;
            padding: 15px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            margin-bottom: 15px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .grilla-row {
            display: grid;
            grid-template-columns: 50px 1fr 150px 200px 150px;
            gap: 15px;
            padding: 15px;
            background: rgba(31, 41, 55, 0.5);
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            margin-bottom: 10px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .grilla-row:hover {
            border-color: var(--accent-gold);
            background: rgba(139, 92, 246, 0.1);
        }

        .alumno-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--accent-gold);
        }

        .alumno-nombre {
            font-weight: 700;
            color: var(--text-primary);
        }

        .calificacion-input {
            width: 100%;
            padding: 10px;
            background: rgba(31, 41, 55, 0.8);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .calificacion-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
        }

        .feedback-input {
            width: 100%;
            padding: 8px;
            background: rgba(31, 41, 55, 0.8);
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .feedback-input:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
        }

        .xp-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-weight: 800;
            font-size: 1.1rem;
        }

        .xp-preview.positive {
            color: #10b981;
        }

        .xp-preview.zero {
            color: #6b7280;
        }

        .btn-guardar-calificaciones {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: 2px solid #10b981;
            border-radius: 12px;
            font-weight: 800;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .btn-guardar-calificaciones:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
        }

        .btn-guardar-calificaciones:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1));
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .grilla-header, .grilla-row {
                grid-template-columns: 40px 1fr 80px 120px;
                gap: 10px;
            }

            .feedback-column {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container actividades-container">
        <div class="header">
            <h1 id="grupo-nombre">
                <img src="/images/logo-escuela.svg" alt="Logo Escuela" class="logo-escuela">
                üìù Actividades y Calificaciones
            </h1>
            <p id="grupo-info">Cargando informaci√≥n...</p>
            <div style="display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap;">
                <button class="back-button" onclick="volverDashboard()">‚Üê Volver al Dashboard</button>
                <button class="back-button" onclick="abrirModalNuevaActividad()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border-color: #10b981;">
                    ‚ûï Nueva Actividad
                </button>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Cargando actividades...</p>
        </div>

        <div id="contenido" style="display: none;">
            <h2 style="color: var(--text-primary); margin-bottom: 20px;">Actividades del Grupo</h2>

            <div id="actividades-list" class="actividades-list">
                <!-- Las actividades se cargar√°n aqu√≠ -->
            </div>

            <!-- Secci√≥n de calificaci√≥n -->
            <div id="calificacion-section" class="calificacion-section">
                <h2 style="color: var(--text-primary); margin-bottom: 20px;">
                    Calificar: <span id="actividad-seleccionada-titulo"></span>
                </h2>

                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-value" id="puntos-maximos">0</div>
                        <div class="stat-label">Puntos M√°ximos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-alumnos">0</div>
                        <div class="stat-label">Total Alumnos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="alumnos-calificados">0</div>
                        <div class="stat-label">Calificados</div>
                    </div>
                </div>

                <div class="grilla-header">
                    <div>#</div>
                    <div>Alumno</div>
                    <div>Calificaci√≥n</div>
                    <div class="feedback-column">Feedback</div>
                    <div>XP a Ganar</div>
                </div>

                <div id="grilla-calificaciones">
                    <!-- La grilla se cargar√° aqu√≠ -->
                </div>

                <button id="btn-guardar" class="btn-guardar-calificaciones" onclick="guardarCalificaciones()">
                    üíæ Guardar Calificaciones
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para crear nueva actividad -->
    <div id="modal-nueva-actividad" class="modal-overlay">
        <div class="modal">
            <h3>‚ûï Crear Nueva Actividad</h3>

            <label style="display: block; margin-bottom: 5px; font-weight: 600;">T√≠tulo de la actividad:</label>
            <input type="text" id="nueva-titulo" class="modal-input" placeholder="Ej: Tarea 1 - Matem√°ticas" required maxlength="200">

            <label style="display: block; margin-bottom: 5px; font-weight: 600; margin-top: 15px;">Puntos m√°ximos (XP):</label>
            <input type="number" id="nueva-puntos" class="modal-input" min="1" max="10000" value="100" required>
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                üí° Tip: 100 XP para tareas, 200-500 XP para proyectos, 1000+ XP para eventos especiales
            </p>

            <label style="display: block; margin-bottom: 5px; font-weight: 600; margin-top: 15px;">Descripci√≥n (opcional):</label>
            <textarea id="nueva-descripcion" class="modal-input" rows="3" placeholder="Describe la actividad..." maxlength="1000"></textarea>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModalNuevaActividad()">Cancelar</button>
                <button class="btn btn-primary" onclick="crearActividad()">Crear Actividad</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        const params = new URLSearchParams(window.location.search);
        const grupoId = params.get('grupo');

        let actividadSeleccionada = null;
        let alumnos = [];
        let actividades = [];

        // ============================================
        // INICIALIZACI√ìN
        // ============================================

        async function inicializar() {
            if (!grupoId) {
                alert('No se especific√≥ un grupo');
                window.location.href = '/';
                return;
            }

            try {
                await Promise.all([
                    cargarGrupo(),
                    cargarActividades(),
                    cargarAlumnos()
                ]);
            } catch (error) {
                console.error('Error al inicializar:', error);
                mostrarError('Error al cargar los datos');
            }
        }

        // Cargar informaci√≥n del grupo
        async function cargarGrupo() {
            try {
                const response = await fetch(`${API_URL}/grupos/${grupoId}`);
                const data = await response.json();

                if (data.success) {
                    const grupo = data.data;
                    const nivelTexto = grupo.nivel === 'Secundaria' ? 'Secundaria t√©cnica #50' : grupo.nivel;
                    document.getElementById('grupo-nombre').innerHTML = `
                        <img src="/images/logo-escuela.svg" alt="Logo Escuela" class="logo-escuela">
                        üìù ${grupo.grado}${grupo.grupo} - Actividades
                    `;
                    document.getElementById('grupo-info').textContent = `${nivelTexto} | Ciclo ${grupo.cicloEscolar}`;
                }
            } catch (error) {
                console.error('Error al cargar grupo:', error);
            }
        }

        // Cargar actividades del grupo
        async function cargarActividades() {
            try {
                const response = await fetch(`${API_URL}/actividades/grupo/${grupoId}?soloActivas=true`);
                const data = await response.json();

                if (data.success) {
                    actividades = data.data;
                    renderizarActividades();
                }
            } catch (error) {
                console.error('Error al cargar actividades:', error);
                mostrarError('Error al cargar las actividades');
            }
        }

        // Cargar alumnos del grupo
        async function cargarAlumnos() {
            try {
                const response = await fetch(`${API_URL}/grupos/${grupoId}/alumnos`);
                const data = await response.json();

                if (data.success) {
                    alumnos = data.data.filter(a => a.activo);
                    document.getElementById('total-alumnos').textContent = alumnos.length;
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('contenido').style.display = 'block';
            } catch (error) {
                console.error('Error al cargar alumnos:', error);
                mostrarError('Error al cargar los alumnos');
            }
        }

        // ============================================
        // RENDERIZADO DE ACTIVIDADES
        // ============================================

        function renderizarActividades() {
            const container = document.getElementById('actividades-list');

            if (actividades.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p style="font-size: 3rem;">üìù</p>
                        <p style="font-size: 1.2rem; font-weight: 600;">No hay actividades a√∫n</p>
                        <p>Crea tu primera actividad para comenzar</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = actividades.map(actividad => {
                const fecha = new Date(actividad.fecha).toLocaleDateString('es-MX', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                });

                return `
                    <div class="actividad-card ${actividadSeleccionada?._id === actividad._id ? 'selected' : ''}"
                         onclick="seleccionarActividad('${actividad._id}')">
                        <div class="actividad-header">
                            <div class="actividad-titulo">${actividad.titulo}</div>
                            <div class="actividad-puntos">‚ö° ${actividad.puntosMaximos} XP</div>
                        </div>
                        ${actividad.descripcion ? `<div class="actividad-info">${actividad.descripcion}</div>` : ''}
                        <div class="actividad-info">üìÖ ${fecha}</div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // SELECCI√ìN DE ACTIVIDAD Y CALIFICACI√ìN
        // ============================================

        async function seleccionarActividad(actividadId) {
            actividadSeleccionada = actividades.find(a => a._id === actividadId);

            if (!actividadSeleccionada) return;

            // Actualizar UI
            renderizarActividades();
            document.getElementById('calificacion-section').classList.add('active');
            document.getElementById('actividad-seleccionada-titulo').textContent = actividadSeleccionada.titulo;
            document.getElementById('puntos-maximos').textContent = actividadSeleccionada.puntosMaximos;

            // Cargar calificaciones existentes
            await cargarCalificacionesExistentes(actividadId);
            renderizarGrillaCalificacion();

            // Scroll a la secci√≥n
            document.getElementById('calificacion-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function cargarCalificacionesExistentes(actividadId) {
            try {
                const response = await fetch(`${API_URL}/actividades/${actividadId}/estadisticas`);
                const data = await response.json();

                if (data.success && data.data.calificaciones) {
                    const calificaciones = data.data.calificaciones;

                    // Agregar calificaciones existentes a los alumnos
                    alumnos.forEach(alumno => {
                        const calif = calificaciones.find(c => c.alumno._id === alumno._id);
                        alumno.calificacionExistente = calif || null;
                    });

                    document.getElementById('alumnos-calificados').textContent = calificaciones.length;
                }
            } catch (error) {
                console.error('Error al cargar calificaciones existentes:', error);
            }
        }

        function renderizarGrillaCalificacion() {
            const container = document.getElementById('grilla-calificaciones');

            container.innerHTML = alumnos.map((alumno, index) => {
                const avatarUrl = `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(alumno.nombreCompleto)}`;
                const calif = alumno.calificacionExistente;
                const calificacionActual = calif ? calif.calificacion : '';
                const feedbackActual = calif ? calif.feedback : '';

                return `
                    <div class="grilla-row" data-alumno-id="${alumno._id}">
                        <div>${index + 1}</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="${avatarUrl}" alt="${alumno.nombreCompleto}" class="alumno-avatar">
                            <span class="alumno-nombre">${alumno.nombreCompleto}</span>
                        </div>
                        <div>
                            <input type="number"
                                   class="calificacion-input"
                                   data-alumno-id="${alumno._id}"
                                   value="${calificacionActual}"
                                   min="0"
                                   max="15"
                                   step="0.5"
                                   placeholder="0-10"
                                   oninput="calcularXPTiempoReal('${alumno._id}', this.value)">
                        </div>
                        <div class="feedback-column">
                            <input type="text"
                                   class="feedback-input"
                                   data-alumno-id="${alumno._id}"
                                   value="${feedbackActual}"
                                   placeholder="Comentario (opcional)"
                                   maxlength="500">
                        </div>
                        <div class="xp-preview zero" id="xp-preview-${alumno._id}">
                            ${calif ? `+${calif.xpGanado} XP` : '0 XP'}
                        </div>
                    </div>
                `;
            }).join('');

            // Calcular XP inicial para calificaciones existentes
            alumnos.forEach(alumno => {
                if (alumno.calificacionExistente) {
                    const input = document.querySelector(`input.calificacion-input[data-alumno-id="${alumno._id}"]`);
                    if (input) {
                        calcularXPTiempoReal(alumno._id, input.value);
                    }
                }
            });
        }

        // ============================================
        // C√ÅLCULO DE XP EN TIEMPO REAL
        // ============================================

        function calcularXPTiempoReal(alumnoId, calificacion) {
            const previewElement = document.getElementById(`xp-preview-${alumnoId}`);

            if (!calificacion || calificacion === '' || parseFloat(calificacion) === 0) {
                previewElement.textContent = '0 XP';
                previewElement.className = 'xp-preview zero';
                return;
            }

            // F√≥rmula: XP = (Calificaci√≥n / 10) * Puntos_M√°ximos
            const xpGanado = Math.round((parseFloat(calificacion) / 10) * actividadSeleccionada.puntosMaximos);

            previewElement.textContent = `+${xpGanado} XP`;
            previewElement.className = 'xp-preview positive';
        }

        // ============================================
        // GUARDAR CALIFICACIONES
        // ============================================

        async function guardarCalificaciones() {
            const calificaciones = [];
            let hayCalificaciones = false;

            alumnos.forEach(alumno => {
                const inputCalif = document.querySelector(`input.calificacion-input[data-alumno-id="${alumno._id}"]`);
                const inputFeedback = document.querySelector(`input.feedback-input[data-alumno-id="${alumno._id}"]`);

                const calificacion = parseFloat(inputCalif.value);
                const feedback = inputFeedback.value.trim();

                if (!isNaN(calificacion) && calificacion > 0) {
                    hayCalificaciones = true;
                    calificaciones.push({
                        alumnoId: alumno._id,
                        calificacion,
                        feedback
                    });
                }
            });

            if (!hayCalificaciones) {
                mostrarError('Debes ingresar al menos una calificaci√≥n');
                return;
            }

            // Confirmar
            if (!confirm(`¬øGuardar ${calificaciones.length} calificaciones?`)) {
                return;
            }

            // Deshabilitar bot√≥n
            const btn = document.getElementById('btn-guardar');
            btn.disabled = true;
            btn.textContent = '‚è≥ Guardando...';

            try {
                const response = await fetch(`${API_URL}/actividades/${actividadSeleccionada._id}/calificar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ calificaciones })
                });

                const data = await response.json();

                if (data.success) {
                    mostrarExito(`‚úÖ ${data.data.resultados.exitosos.length} calificaciones guardadas`);

                    if (data.data.resultados.errores.length > 0) {
                        console.warn('Errores:', data.data.resultados.errores);
                    }

                    // Recargar calificaciones
                    await cargarCalificacionesExistentes(actividadSeleccionada._id);
                    renderizarGrillaCalificacion();
                } else {
                    mostrarError(data.message || 'Error al guardar');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error al guardar las calificaciones');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Guardar Calificaciones';
            }
        }

        // ============================================
        // MODAL NUEVA ACTIVIDAD
        // ============================================

        function abrirModalNuevaActividad() {
            document.getElementById('modal-nueva-actividad').style.display = 'flex';
            document.getElementById('nueva-titulo').value = '';
            document.getElementById('nueva-puntos').value = '100';
            document.getElementById('nueva-descripcion').value = '';
        }

        function cerrarModalNuevaActividad() {
            document.getElementById('modal-nueva-actividad').style.display = 'none';
        }

        async function crearActividad() {
            const titulo = document.getElementById('nueva-titulo').value.trim();
            const puntosMaximos = parseInt(document.getElementById('nueva-puntos').value);
            const descripcion = document.getElementById('nueva-descripcion').value.trim();

            if (!titulo) {
                mostrarError('Debes ingresar un t√≠tulo');
                return;
            }

            if (!puntosMaximos || puntosMaximos < 1 || puntosMaximos > 10000) {
                mostrarError('Los puntos deben estar entre 1 y 10,000');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/actividades`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        titulo,
                        puntosMaximos,
                        descripcion,
                        grupo: grupoId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    mostrarExito('‚úÖ Actividad creada exitosamente');
                    cerrarModalNuevaActividad();
                    await cargarActividades();
                } else {
                    mostrarError(data.message || 'Error al crear actividad');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error al crear la actividad');
            }
        }

        // ============================================
        // NAVEGACI√ìN
        // ============================================

        function volverDashboard() {
            window.location.href = `/dashboard.html?grupo=${grupoId}`;
        }

        // ============================================
        // NOTIFICACIONES
        // ============================================

        function mostrarError(mensaje) {
            const notification = document.createElement('div');
            notification.className = 'notification error';
            notification.textContent = mensaje;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function mostrarExito(mensaje) {
            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.textContent = mensaje;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Inicializar al cargar
        inicializar();
    </script>
</body>
</html>
