<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Aula - Seleccionar Grupo</title>
    <link rel="icon" type="image/svg+xml" href="/images/logo-escuela.svg">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header" style="position: relative;">
            <h1>
                <img src="/images/logo-escuela.svg" alt="Logo Escuela" class="logo-escuela">
                üéì Control de Aula
            </h1>
            <p>Selecciona un grupo para comenzar</p>
            <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;">
                <button onclick="window.location.href='/admin-grupos.html'" class="btn-backup" style="background: linear-gradient(135deg, var(--accent-gold), var(--accent-gold-dark)); color: #1f2937; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3); transition: all 0.3s ease;">
                    ‚öôÔ∏è Administrar Grupos
                </button>
                <button onclick="exportarPuntos()" class="btn-backup" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3); transition: all 0.3s ease;">
                    üíæ Respaldar Puntos XP/HP
                </button>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Cargando grupos...</p>
        </div>

        <div id="grupos-container" class="grupos-grid" style="display: none;">
            <!-- Los grupos se cargar√°n aqu√≠ din√°micamente -->
        </div>
    </div>

    <script>
        const API_URL = '/api';

        // Cargar grupos al iniciar
        async function cargarGrupos() {
            try {
                const response = await fetch(`${API_URL}/grupos`);
                const data = await response.json();

                if (data.success) {
                    mostrarGrupos(data.data);
                } else {
                    mostrarError('Error al cargar los grupos');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error de conexi√≥n con el servidor');
            }
        }

        // Mostrar grupos en el grid
        function mostrarGrupos(grupos) {
            const container = document.getElementById('grupos-container');
            const loading = document.getElementById('loading');

            if (grupos.length === 0) {
                loading.innerHTML = '<p>No hay grupos registrados</p>';
                return;
            }

            loading.style.display = 'none';
            container.style.display = 'grid';

            container.innerHTML = grupos.map(grupo => {
                // Personalizar el nombre del nivel para Secundaria
                const nivelTexto = grupo.nivel === 'Secundaria' ? 'Secundaria t√©cnica #50' : grupo.nivel;
                const sesiones = grupo.sesionesImpartidas || 0;
                const materia = grupo.materia || 'General';
                return `
                <div class="grupo-card" onclick="irADashboard('${grupo._id}')">
                    <h3>${grupo.grado}¬∞${grupo.grupo}</h3>
                    <div class="info" style="font-size: 1.3em; font-weight: 600; color: var(--accent-gold); margin: 10px 0;">
                        üìö ${materia}
                    </div>
                    <div class="info">üìÖ Ciclo: ${grupo.cicloEscolar}</div>
                    <div class="info">üìä Clases: ${sesiones}</div>
                    <span class="nivel">${nivelTexto}</span>
                </div>
                `;
            }).join('');
        }

        // Navegar al dashboard del grupo
        function irADashboard(grupoId) {
            window.location.href = `/dashboard.html?grupo=${grupoId}`;
        }

        // Mostrar notificaci√≥n de error
        function mostrarError(mensaje) {
            const notification = document.createElement('div');
            notification.className = 'notification error';
            notification.textContent = mensaje;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Exportar/Respaldar puntos XP/HP
        function exportarPuntos() {
            // Mostrar confirmaci√≥n
            const confirmacion = confirm(
                'üíæ RESPALDO DE PUNTOS XP/HP\n\n' +
                'Se descargar√° un archivo CSV con todos los puntos de tus alumnos.\n\n' +
                '¬°Gu√°rdalo en un lugar seguro para poder restaurar en caso necesario!\n\n' +
                '¬øContinuar?'
            );

            if (!confirmacion) return;

            // Descargar el archivo
            window.location.href = `${API_URL}/backup/exportar-puntos`;

            // Mostrar mensaje de √©xito
            setTimeout(() => {
                const notification = document.createElement('div');
                notification.className = 'notification success';
                notification.innerHTML = '‚úÖ Backup descargado correctamente<br>üí° Gu√°rdalo en un lugar seguro';
                notification.style.cssText = 'background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 12px; position: fixed; top: 20px; right: 20px; z-index: 10000; box-shadow: 0 8px 16px rgba(0,0,0,0.3); font-weight: 600; max-width: 300px; text-align: center;';
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }, 500);
        }

        // Inicializar
        cargarGrupos();
    </script>
</body>
</html>
