<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Aula - Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/images/logo-escuela.svg">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="grupo-nombre">
                <img src="/images/logo-escuela.svg" alt="Logo Escuela" class="logo-escuela">
                Cargando...
            </h1>
            <p id="grupo-info">Informaci√≥n del grupo</p>
            <!-- üíæ Indicador de auto-guardado -->
            <div id="indicador-guardado" style="display: none; position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 20px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); z-index: 9999; animation: fadeIn 0.3s ease;">
                üíæ Guardando asistencias...
            </div>
            <div style="display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap;">
                <button class="back-button" onclick="window.location.href='/'">‚Üê Volver a grupos</button>
                <button id="btn-iniciar-clase" class="back-button" onclick="tomarLista()" style="background: linear-gradient(135deg, var(--accent-gold), var(--accent-gold-dark)); color: #1f2937; border-color: var(--accent-gold);">
                    üìã Tomar Lista
                </button>
                <button class="back-button" onclick="verTablaAsistencias()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border-color: #10b981;">
                    üìÖ Tabla Asistencias
                </button>
                <button class="back-button" onclick="verRanking()" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-color: #f59e0b;">
                    üèÜ Ranking
                </button>
                <button class="back-button" onclick="verHistorial()" style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; border-color: #06b6d4;">
                    üìä Ver Historial
                </button>
                <button class="back-button" onclick="verActividades()" style="background: linear-gradient(135deg, #ec4899, #db2777); color: white; border-color: #ec4899;">
                    üìù Actividades
                </button>
                <button class="back-button" onclick="abrirImportarPlickers()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border-color: #8b5cf6;">
                    üìÇ Importar Plickers
                </button>
            </div>
        </div>

        <!-- Input file oculto para importar CSV -->
        <input type="file" id="input-csv-plickers" accept=".csv" style="display: none;" onchange="procesarArchivoPlickers(event)">

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Cargando alumnos...</p>
        </div>

        <div id="alumnos-container" class="alumnos-grid" style="display: none;">
            <!-- Los alumnos se cargar√°n aqu√≠ din√°micamente -->
        </div>
    </div>

    <!-- Modal para registrar salida -->
    <div id="modal-salida" class="modal-overlay">
        <div class="modal">
            <h3>Registrar Salida</h3>
            <p id="modal-alumno-nombre" style="margin-bottom: 20px; color: #6b7280; font-weight: 600;"></p>

            <div class="modal-buttons">
                <button class="modal-btn" data-tipo="ba√±o">üöΩ Ba√±o</button>
                <button class="modal-btn" data-tipo="enfermer√≠a">üè• Enfermer√≠a</button>
                <button class="modal-btn" data-tipo="agua">üíß Agua</button>
                <button class="modal-btn" data-tipo="otros">üìù Otros</button>
            </div>

            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Observaciones (opcional):</label>
            <textarea id="salida-observaciones" class="modal-input" rows="3" placeholder="Escribe alguna observaci√≥n..."></textarea>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModal('salida')">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarSalida()">Registrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para registrar evento disciplinario -->
    <div id="modal-disciplina" class="modal-overlay">
        <div class="modal">
            <h3>Registrar Evento Disciplinario</h3>
            <p id="modal-disciplina-alumno" style="margin-bottom: 20px; color: #6b7280; font-weight: 600;"></p>

            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tipo de falta:</label>
            <div class="modal-buttons">
                <button class="modal-btn" data-tipo="indisciplina">‚ö†Ô∏è Indisciplina</button>
                <button class="modal-btn" data-tipo="tel√©fono">üì± Tel√©fono</button>
                <button class="modal-btn" data-tipo="dormido">üò¥ Dormido</button>
                <button class="modal-btn" data-tipo="otros">üìù Otros</button>
            </div>

            <label style="display: block; margin-bottom: 5px; font-weight: 600; margin-top: 15px;">Puntos a descontar:</label>
            <input type="number" id="disciplina-puntos" class="modal-input" min="1" max="100" value="5">

            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Observaciones:</label>
            <textarea id="disciplina-observaciones" class="modal-input" rows="3" placeholder="Describe la situaci√≥n..." required></textarea>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModal('disciplina')">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarDisciplina()">Registrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para ajustar XP/HP -->
    <div id="modal-ajuste-xp" class="modal-overlay">
        <div class="modal">
            <h3>‚ö° Ajustar XP / HP</h3>
            <div id="ajuste-alumno-info" style="margin-bottom: 20px; padding: 15px; background: rgba(139, 92, 246, 0.1); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 12px;">
                <div style="font-weight: 800; font-size: 1.1rem; color: var(--text-primary); margin-bottom: 5px;" id="ajuste-alumno-nombre">Alumno</div>
                <div style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">
                    <span id="ajuste-alumno-stats">‚ö° 0 XP | ‚ù§Ô∏è 0 HP</span>
                </div>
            </div>
            <input type="hidden" id="ajuste-alumno-id">

            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tipo de ajuste:</label>
            <div class="modal-buttons" style="margin-bottom: 15px;">
                <button class="modal-btn" data-tipo-ajuste="xp-positivo" style="background: rgba(16, 185, 129, 0.2); border-color: #10b981; color: #10b981;">
                    ‚ö° Otorgar XP
                </button>
                <button class="modal-btn" data-tipo-ajuste="xp-negativo" style="background: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #ef4444;">
                    ‚ö° Quitar XP
                </button>
                <button class="modal-btn" data-tipo-ajuste="hp-positivo" style="background: rgba(16, 185, 129, 0.2); border-color: #10b981; color: #10b981;">
                    ‚ù§Ô∏è Otorgar HP
                </button>
                <button class="modal-btn" data-tipo-ajuste="hp-negativo" style="background: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #ef4444;">
                    ‚ù§Ô∏è Quitar HP
                </button>
            </div>

            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Cantidad XP:</label>
            <input type="number" id="ajuste-cantidad" class="modal-input" min="1" max="1000" value="10" style="margin-bottom: 15px;">

            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Motivo:</label>
            <select id="ajuste-motivo" class="modal-input" style="width: 100%; margin-bottom: 15px;">
                <option value="Tarea">Tarea</option>
                <option value="Pr√°ctica">Pr√°ctica</option>
                <option value="Plickers">Plickers</option>
                <option value="Jeopardy">Jeopardy</option>
                <option value="Reto (examen)">Reto (examen)</option>
                <option value="Bonus de Constancia (Asistencia)">Bonus de Constancia (Asistencia)</option>
                <option value="Extra">Extra</option>
                <option value="Escaperoom">Escaperoom</option>
                <option value="Otro">Otro</option>
            </select>

            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Observaciones (opcional):</label>
            <textarea id="ajuste-observaciones" class="modal-input" rows="3" placeholder="Detalles adicionales..."></textarea>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModal('ajuste-xp')">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarAjusteXP()">Confirmar Ajuste</button>
            </div>
        </div>
    </div>

    <!-- Modal para cambiar estado de asistencia (Modo Clase Activa) -->
    <div id="modal-cambiar-estado" class="modal-overlay">
        <div class="modal">
            <h3>üîÑ Cambiar Estado de Asistencia</h3>
            <div id="cambiar-estado-alumno-info" style="margin-bottom: 20px; padding: 15px; background: rgba(139, 92, 246, 0.1); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 12px;">
                <div style="font-weight: 800; font-size: 1.1rem; color: var(--text-primary); margin-bottom: 5px;" id="cambiar-estado-alumno-nombre">Alumno</div>
                <div style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">
                    <span>Estado actual: <span id="cambiar-estado-actual" style="font-weight: 800; color: var(--accent-gold);">-</span></span>
                </div>
            </div>
            <input type="hidden" id="cambiar-estado-alumno-id">

            <label style="display: block; margin-bottom: 10px; font-weight: 600;">Selecciona el nuevo estado:</label>
            <div class="modal-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button class="modal-btn" data-nuevo-estado="presente" style="background: rgba(16, 185, 129, 0.2); border-color: #10b981; color: #10b981; padding: 20px;">
                    <div style="font-size: 2rem; margin-bottom: 5px;">‚úì</div>
                    <div style="font-weight: 700;">PRESENTE</div>
                </button>
                <button class="modal-btn" data-nuevo-estado="ausente" style="background: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #ef4444; padding: 20px;">
                    <div style="font-size: 2rem; margin-bottom: 5px;">‚úó</div>
                    <div style="font-weight: 700;">AUSENTE</div>
                </button>
                <button class="modal-btn" data-nuevo-estado="retardo" style="background: rgba(245, 158, 11, 0.2); border-color: #f59e0b; color: #f59e0b; padding: 20px;">
                    <div style="font-size: 2rem; margin-bottom: 5px;">üïê</div>
                    <div style="font-weight: 700;">RETARDO</div>
                </button>
                <button class="modal-btn" data-nuevo-estado="justificado" style="background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; color: #3b82f6; padding: 20px;">
                    <div style="font-size: 2rem; margin-bottom: 5px;">üìù</div>
                    <div style="font-weight: 700;">JUSTIFICADO</div>
                </button>
            </div>

            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="cerrarModal('cambiar-estado')">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let grupoActual = null;
        let alumnoSeleccionado = null;
        let tipoSeleccionado = null;
        let claseActiva = null; // üéì Estado de clase activa del sessionStorage

        // ============================================
        // SISTEMA DE AUDIO GAMING üéÆüîä
        // ============================================
        const sonidos = {
            xpGain: new Audio('/sounds/xp-gain.mp3'),          // Monedas/Power-up
            xpBigGain: new Audio('/sounds/xp-big-gain.mp3'),   // XP grande (100+)
            xpLose: new Audio('/sounds/xp-lose.mp3'),          // Perder XP
            hpGain: new Audio('/sounds/hp-gain.mp3'),          // Recuperar vida
            hpLose: new Audio('/sounds/hp-lose.mp3'),          // Da√±o/Perder HP
            click: new Audio('/sounds/click.mp3'),             // Click general
            success: new Audio('/sounds/success.mp3'),         // Acci√≥n exitosa
            error: new Audio('/sounds/error.mp3'),             // Error/Cancelar
            complete: new Audio('/sounds/complete.mp3')        // Tarea completada
        };

        // Configurar volumen de todos los sonidos (0.0 a 1.0)
        Object.values(sonidos).forEach(audio => {
            audio.volume = 0.4; // 40% de volumen (ajustable)
        });

        // Funci√≥n helper para reproducir sonidos
        function reproducirSonido(nombreSonido) {
            try {
                const audio = sonidos[nombreSonido];
                if (audio) {
                    audio.currentTime = 0; // Reiniciar si ya est√° sonando
                    audio.play().catch(err => {
                        // Ignorar errores de autoplay (navegador bloqueado)
                        console.log('Audio bloqueado por el navegador:', err);
                    });
                }
            } catch (error) {
                console.error('Error al reproducir sonido:', error);
            }
        }

        // Obtener ID del grupo desde la URL
        const urlParams = new URLSearchParams(window.location.search);
        const grupoId = urlParams.get('grupo');

        if (!grupoId) {
            window.location.href = '/';
        }

        // üéì Cargar estado de clase activa desde sessionStorage
        function cargarClaseActiva() {
            const claseActivaStr = sessionStorage.getItem('claseActiva');
            if (claseActivaStr) {
                try {
                    const claseActivaData = JSON.parse(claseActivaStr);
                    // Verificar que sea del mismo grupo
                    if (claseActivaData.grupoId === grupoId && claseActivaData.activa) {
                        claseActiva = claseActivaData;
                        console.log('‚úÖ Clase activa detectada:', claseActiva);
                        actualizarBotonClase();

                        // üíæ Iniciar sistema de auto-guardado
                        iniciarAutoGuardado();

                        return true;
                    }
                } catch (error) {
                    console.error('Error al parsear clase activa:', error);
                }
            }
            claseActiva = null;
            actualizarBotonClase();
            return false;
        }

        // üéì Actualizar bot√≥n seg√∫n estado de clase (Iniciar/Finalizar)
        function actualizarBotonClase() {
            const btnTomarLista = document.getElementById('btn-iniciar-clase');
            if (!btnTomarLista) {
                console.warn('‚ö†Ô∏è No se encontr√≥ el bot√≥n de iniciar clase');
                return;
            }

            if (claseActiva && claseActiva.activa) {
                // Cambiar a "Finalizar Clase"
                btnTomarLista.textContent = 'üèÅ Finalizar Clase';
                btnTomarLista.onclick = finalizarClase;
                btnTomarLista.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                btnTomarLista.style.borderColor = '#ef4444';
                btnTomarLista.style.color = 'white';
            } else {
                // Cambiar a "Iniciar Clase"
                btnTomarLista.textContent = 'üéì Iniciar Clase';
                btnTomarLista.onclick = tomarLista;
                btnTomarLista.style.background = 'linear-gradient(135deg, var(--accent-gold), var(--accent-gold-dark))';
                btnTomarLista.style.borderColor = 'var(--accent-gold)';
                btnTomarLista.style.color = '#1f2937';
            }
        }

        // Cargar informaci√≥n del grupo y sus alumnos
        async function cargarDatos() {
            // Cargar estado de clase activa primero
            cargarClaseActiva();
            try {
                // Cargar informaci√≥n del grupo
                const grupoResponse = await fetch(`${API_URL}/grupos/${grupoId}`);
                const grupoData = await grupoResponse.json();

                if (grupoData.success) {
                    grupoActual = grupoData.data;
                    mostrarInfoGrupo(grupoActual);
                }

                // Cargar alumnos del grupo
                const alumnosResponse = await fetch(`${API_URL}/grupos/${grupoId}/alumnos`);
                const alumnosData = await alumnosResponse.json();

                if (alumnosData.success) {
                    mostrarAlumnos(alumnosData.data);
                } else {
                    mostrarError('Error al cargar los alumnos');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error de conexi√≥n con el servidor');
            }
        }

        // Mostrar informaci√≥n del grupo en el header
        function mostrarInfoGrupo(grupo) {
            const logoHTML = '<img src="/images/logo-escuela.svg" alt="Logo Escuela" class="logo-escuela">';
            // Personalizar el nombre del nivel para Secundaria
            const nivelTexto = grupo.nivel === 'Secundaria' ? 'Secundaria t√©cnica #50' : grupo.nivel;
            const materia = grupo.materia || 'General';
            document.getElementById('grupo-nombre').innerHTML = `${logoHTML}${grupo.grado}¬∞${grupo.grupo} - ${materia}`;
            const sesiones = grupo.sesionesImpartidas || 0;
            document.getElementById('grupo-info').textContent = `${nivelTexto} | Ciclo ${grupo.cicloEscolar} | üìä Clases: ${sesiones}`;
        }

        // Mostrar alumnos en el grid
        function mostrarAlumnos(alumnos) {
            const container = document.getElementById('alumnos-container');
            const loading = document.getElementById('loading');

            if (alumnos.length === 0) {
                loading.innerHTML = '<p>No hay alumnos registrados en este grupo</p>';
                return;
            }

            loading.style.display = 'none';
            container.style.display = 'grid';

            // Ordenar alumnos por apellidos
            alumnos.sort((a, b) => a.apellidos.localeCompare(b.apellidos));

            container.innerHTML = alumnos.map(alumno => {
                const saludClase = alumno.salud <= 30 ? 'low' : alumno.salud <= 60 ? 'medium' : '';

                // Sistema de XP: 0 a 10000 puntos totales
                const xpMaximo = 10000;
                const porcentajeXP = (alumno.xp / xpMaximo) * 100;

                // Avatar de robot √∫nico basado en el nombre del alumno
                const avatarUrl = `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(alumno.nombreCompleto)}`;

                // üéì MODO CLASE ACTIVA: Detectar estado de asistencia
                let estadoClase = '';
                let badgeHTML = '';
                let btnCambiarEstado = '';

                if (claseActiva && claseActiva.asistencias && claseActiva.asistencias[alumno._id]) {
                    const asistencia = claseActiva.asistencias[alumno._id];
                    const estado = asistencia.estado;

                    if (estado === 'ausente') {
                        estadoClase = 'alumno-ausente';
                        badgeHTML = '<div class="estado-badge ausente">‚úó AUSENTE</div>';
                    } else if (estado === 'retardo') {
                        estadoClase = 'alumno-retardo';
                        badgeHTML = '<div class="estado-badge retardo">üïê RETARDO</div>';
                    } else if (estado === 'justificado') {
                        estadoClase = 'alumno-justificado';
                        badgeHTML = '<div class="estado-badge justificado">üìù JUSTIFICADO</div>';
                    }

                    // Bot√≥n para cambiar estado (solo visible cuando hay clase activa)
                    btnCambiarEstado = `
                        <button class="btn-cambiar-estado" onclick="abrirModalCambiarEstado('${alumno._id}', '${alumno.nombreCompleto.replace(/'/g, "\\'")}', '${estado}')">
                            üîÑ Cambiar Estado
                        </button>
                    `;
                }

                return `
                    <div class="alumno-card ${estadoClase}">
                        ${badgeHTML}
                        <div class="alumno-header">
                            <div class="alumno-avatar">
                                <img src="${avatarUrl}" alt="${alumno.nombreCompleto}" style="width: 100%; height: 100%; border-radius: 50%;">
                            </div>
                            <div class="alumno-info">
                                <div class="alumno-nombre">${alumno.nombreCompleto}</div>
                            </div>
                        </div>

                        <div class="alumno-stats">
                            <div class="stat-box" onclick="verInsignias()" title="Ver sistema de insignias y privilegios" style="cursor: pointer; background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.15)); border-color: rgba(251, 191, 36, 0.4);">
                                <div class="stat-label">üèÖ Insignia</div>
                                <div class="stat-value level-value">-</div>
                            </div>
                            <div class="stat-box xp-box" onclick="abrirModalAjusteXP('${alumno._id}', '${alumno.nombreCompleto.replace(/'/g, "\\'")}', ${alumno.xp}, ${alumno.salud})" title="Click para ajustar XP/HP">
                                <div class="stat-label">‚ö° XP Total</div>
                                <div class="stat-value xp-value">${alumno.xp}</div>
                            </div>
                        </div>

                        <div class="xp-progress">
                            <div class="xp-progress-label">
                                <span>‚ö° Progreso XP</span>
                                <span>${alumno.xp}/${xpMaximo}</span>
                            </div>
                            <div class="xp-progress-bar">
                                <div class="xp-progress-fill" style="width: ${porcentajeXP}%"></div>
                            </div>
                        </div>

                        <div class="health-bar">
                            <div class="health-bar-label">
                                <span class="hp-text">‚ù§Ô∏è HP</span>
                                <span>${alumno.salud}/100</span>
                            </div>
                            <div class="health-bar-container">
                                <div class="health-bar-fill ${saludClase}" style="width: ${alumno.salud}%">
                                    ${alumno.salud}
                                </div>
                            </div>
                        </div>

                        <div class="actions">
                            <button class="action-btn salida" onclick="abrirModalSalida('${alumno._id}', '${alumno.nombreCompleto}')">
                                üö™ Salida
                            </button>
                            <button class="action-btn disciplina" onclick="abrirModalDisciplina('${alumno._id}', '${alumno.nombreCompleto}')">
                                ‚ö†Ô∏è Disciplina
                            </button>
                        </div>
                        ${btnCambiarEstado}
                    </div>
                `;
            }).join('');
        }

        // Abrir modal para registrar salida
        function abrirModalSalida(alumnoId, nombreCompleto) {
            alumnoSeleccionado = alumnoId;
            tipoSeleccionado = null;
            document.getElementById('modal-alumno-nombre').textContent = `Alumno: ${nombreCompleto}`;
            document.getElementById('salida-observaciones').value = '';

            // Limpiar selecci√≥n previa
            document.querySelectorAll('#modal-salida .modal-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            document.getElementById('modal-salida').classList.add('active');
        }

        // Abrir modal para evento disciplinario
        function abrirModalDisciplina(alumnoId, nombreCompleto) {
            alumnoSeleccionado = alumnoId;
            tipoSeleccionado = null;
            document.getElementById('modal-disciplina-alumno').textContent = `Alumno: ${nombreCompleto}`;
            document.getElementById('disciplina-observaciones').value = '';
            document.getElementById('disciplina-puntos').value = 5;

            // Limpiar selecci√≥n previa
            document.querySelectorAll('#modal-disciplina .modal-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            document.getElementById('modal-disciplina').classList.add('active');
        }

        // Cerrar modal
        function cerrarModal(tipo) {
            document.getElementById(`modal-${tipo}`).classList.remove('active');
            alumnoSeleccionado = null;
            tipoSeleccionado = null;
        }

        // üéì FUNCIONES PARA MODO CLASE ACTIVA

        // Abrir modal para cambiar estado de asistencia
        function abrirModalCambiarEstado(alumnoId, nombreCompleto, estadoActual) {
            if (!claseActiva) {
                mostrarError('No hay una clase activa');
                return;
            }

            alumnoSeleccionado = alumnoId;
            document.getElementById('cambiar-estado-alumno-nombre').textContent = nombreCompleto;

            // Mostrar estado actual con formato bonito
            const estadosFormato = {
                'presente': '‚úì Presente',
                'ausente': '‚úó Ausente',
                'retardo': 'üïê Retardo',
                'justificado': 'üìù Justificado'
            };
            document.getElementById('cambiar-estado-actual').textContent = estadosFormato[estadoActual] || estadoActual;
            document.getElementById('cambiar-estado-alumno-id').value = alumnoId;

            // Limpiar selecci√≥n previa
            document.querySelectorAll('#modal-cambiar-estado .modal-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            document.getElementById('modal-cambiar-estado').classList.add('active');
        }

        // Event listener para los botones de cambio de estado
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('#modal-cambiar-estado [data-nuevo-estado]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const nuevoEstado = this.getAttribute('data-nuevo-estado');
                    cambiarEstadoAsistencia(nuevoEstado);
                });
            });
        });

        // Cambiar estado de asistencia en sessionStorage y re-renderizar
        function cambiarEstadoAsistencia(nuevoEstado) {
            if (!claseActiva || !alumnoSeleccionado) {
                mostrarError('Error: No se puede cambiar el estado');
                return;
            }

            // Actualizar el estado en sessionStorage
            if (claseActiva.asistencias[alumnoSeleccionado]) {
                claseActiva.asistencias[alumnoSeleccionado].estado = nuevoEstado;

                // Guardar en sessionStorage
                sessionStorage.setItem('claseActiva', JSON.stringify(claseActiva));

                // Sonidos seg√∫n el nuevo estado
                if (nuevoEstado === 'presente') {
                    reproducirSonido('success');
                } else if (nuevoEstado === 'ausente') {
                    reproducirSonido('error');
                } else {
                    reproducirSonido('click');
                }

                // Cerrar modal
                cerrarModal('cambiar-estado');

                // Re-cargar datos para actualizar la visualizaci√≥n
                cargarDatos();

                mostrarExito(`Estado cambiado a: ${nuevoEstado.toUpperCase()}`);

                console.log('‚úÖ Estado actualizado en sessionStorage:', nuevoEstado);
            }
        }

        // Finalizar clase
        async function finalizarClase() {
            if (!claseActiva) {
                mostrarError('No hay una clase activa');
                return;
            }

            // Confirmaci√≥n del docente
            if (!confirm('¬øConfirmar y finalizar la clase?\n\nSe guardar√° el estado final de asistencias.')) {
                return;
            }

            try {
                // Convertir asistencias de objeto a array
                const asistenciasArray = Object.values(claseActiva.asistencias);

                // Incrementar contador de sesiones en el backend
                const grupoId = new URLSearchParams(window.location.search).get('grupo');
                const resIncremento = await fetch(`/api/grupos/${grupoId}/incrementar-sesion`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (resIncremento.ok) {
                    const dataIncremento = await resIncremento.json();
                    console.log(`‚úÖ ${dataIncremento.mensaje}`);
                } else {
                    console.warn('‚ö†Ô∏è No se pudo incrementar el contador de sesiones');
                }

                // üõë Detener el auto-guardado antes de limpiar
                detenerAutoGuardado();

                // Limpiar sessionStorage
                sessionStorage.removeItem('claseActiva');
                claseActiva = null;

                // Sonido de √©xito
                reproducirSonido('complete');

                // Recargar datos para actualizar visualizaci√≥n
                await cargarDatos();

                mostrarExito('‚úÖ Clase finalizada correctamente');

                console.log('‚úÖ Clase finalizada y sessionStorage limpiado');
            } catch (error) {
                console.error('Error al finalizar clase:', error);
                mostrarError('Error al finalizar la clase');
            }
        }

        // ============================================
        // üíæ SISTEMA DE AUTO-GUARDADO
        // ============================================
        let intervaloAutoGuardado = null;

        // Funci√≥n para auto-guardar asistencias en el backend
        async function autoGuardarAsistencia() {
            // Solo ejecutar si hay clase activa
            if (!claseActiva || !claseActiva.activa) {
                console.log('‚è≠Ô∏è Auto-guardado omitido: No hay clase activa');
                return;
            }

            try {
                // Mostrar indicador visual
                mostrarIndicadorGuardado();

                // Convertir asistencias de objeto a array
                const asistenciasArray = Object.keys(claseActiva.asistencias).map(alumnoId => ({
                    alumnoId: alumnoId,
                    estado: claseActiva.asistencias[alumnoId].estado,
                    observaciones: claseActiva.asistencias[alumnoId].observaciones
                }));

                // Enviar al endpoint de auto-guardado (upsert)
                const response = await fetch(`${API_URL}/asistencia/grupo/auto-guardar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        grupoId: claseActiva.grupoId,
                        asistencias: asistenciasArray,
                        fecha: new Date().toISOString().split('T')[0]
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log('‚úÖ Auto-guardado exitoso:', data.data);
                    // Ocultar indicador despu√©s de 2 segundos
                    setTimeout(ocultarIndicadorGuardado, 2000);
                } else {
                    console.error('‚ùå Error en auto-guardado:', data.mensaje);
                    ocultarIndicadorGuardado();
                }
            } catch (error) {
                console.error('‚ùå Error al auto-guardar:', error);
                ocultarIndicadorGuardado();
            }
        }

        // Mostrar indicador de guardado
        function mostrarIndicadorGuardado() {
            const indicador = document.getElementById('indicador-guardado');
            if (indicador) {
                indicador.style.display = 'block';
            }
        }

        // Ocultar indicador de guardado
        function ocultarIndicadorGuardado() {
            const indicador = document.getElementById('indicador-guardado');
            if (indicador) {
                indicador.style.display = 'none';
            }
        }

        // Iniciar el intervalo de auto-guardado
        function iniciarAutoGuardado() {
            // Solo iniciar si hay clase activa y no hay intervalo previo
            if (claseActiva && claseActiva.activa && !intervaloAutoGuardado) {
                console.log('üîÑ Iniciando auto-guardado cada 5 minutos...');

                // Ejecutar el primer guardado inmediatamente
                autoGuardarAsistencia();

                // Configurar intervalo de 5 minutos (300,000 ms)
                intervaloAutoGuardado = setInterval(autoGuardarAsistencia, 300000);
            }
        }

        // Detener el intervalo de auto-guardado
        function detenerAutoGuardado() {
            if (intervaloAutoGuardado) {
                console.log('üõë Deteniendo auto-guardado');
                clearInterval(intervaloAutoGuardado);
                intervaloAutoGuardado = null;
            }
        }

        // üö® Listener para cierre inesperado de ventana o cambio de pesta√±a
        window.addEventListener('beforeunload', async function(e) {
            // Intentar guardar si hay clase activa
            if (claseActiva && claseActiva.activa) {
                // Navigator.sendBeacon es m√°s confiable para beforeunload
                const asistenciasArray = Object.keys(claseActiva.asistencias).map(alumnoId => ({
                    alumnoId: alumnoId,
                    estado: claseActiva.asistencias[alumnoId].estado,
                    observaciones: claseActiva.asistencias[alumnoId].observaciones
                }));

                const payload = {
                    grupoId: claseActiva.grupoId,
                    asistencias: asistenciasArray,
                    fecha: new Date().toISOString().split('T')[0]
                };

                // Crear Blob con tipo application/json para sendBeacon
                const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });

                // Usar sendBeacon para enviar datos de forma confiable
                navigator.sendBeacon(`${API_URL}/asistencia/grupo/auto-guardar`, blob);

                console.log('üíæ Guardado de emergencia ejecutado (beforeunload)');
            }
        });

        // üëÅÔ∏è Listener para cambio de visibilidad (cambio de pesta√±a)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && claseActiva && claseActiva.activa) {
                // Usuario cambi√≥ de pesta√±a, guardar asistencias
                autoGuardarAsistencia();
                console.log('üíæ Auto-guardado por cambio de pesta√±a');
            }
        });

        // Manejar selecci√≥n de tipo en modales
        document.querySelectorAll('.modal-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                modal.querySelectorAll('.modal-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                tipoSeleccionado = this.getAttribute('data-tipo');
            });
        });

        // Confirmar registro de salida
        async function confirmarSalida() {
            if (!tipoSeleccionado) {
                mostrarError('Selecciona un tipo de salida');
                return;
            }

            try {
                const observaciones = document.getElementById('salida-observaciones').value;

                const response = await fetch(`${API_URL}/eventos/salida`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        alumno: alumnoSeleccionado,
                        tipoSalida: tipoSeleccionado,
                        horaSalida: new Date().toISOString(),
                        observaciones: observaciones || undefined
                    })
                });

                const data = await response.json();

                if (data.success) {
                    mostrarExito('Salida registrada correctamente');
                    cerrarModal('salida');
                    // Recargar alumnos
                    await cargarDatos();
                } else {
                    mostrarError(data.mensaje || 'Error al registrar la salida');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error de conexi√≥n con el servidor');
            }
        }

        // Confirmar registro de evento disciplinario
        async function confirmarDisciplina() {
            if (!tipoSeleccionado) {
                mostrarError('Selecciona un tipo de falta');
                return;
            }

            const observaciones = document.getElementById('disciplina-observaciones').value;
            if (!observaciones.trim()) {
                mostrarError('Las observaciones son obligatorias');
                return;
            }

            const puntos = parseInt(document.getElementById('disciplina-puntos').value);
            if (puntos < 1 || puntos > 100) {
                mostrarError('Los puntos deben estar entre 1 y 100');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/eventos/disciplinario`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        alumno: alumnoSeleccionado,
                        tipoDisciplina: tipoSeleccionado,
                        puntosDescontados: puntos,
                        observaciones: observaciones
                    })
                });

                const data = await response.json();

                if (data.success) {
                    mostrarExito('Evento disciplinario registrado correctamente');
                    cerrarModal('disciplina');
                    // Recargar alumnos para ver la salud actualizada
                    await cargarDatos();
                } else {
                    mostrarError(data.mensaje || 'Error al registrar el evento');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error de conexi√≥n con el servidor');
            }
        }

        // Mostrar notificaci√≥n de √©xito
        function mostrarExito(mensaje) {
            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.textContent = mensaje;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Mostrar notificaci√≥n de error
        function mostrarError(mensaje) {
            const notification = document.createElement('div');
            notification.className = 'notification error';
            notification.textContent = mensaje;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Ir a toma de lista
        function tomarLista() {
            window.location.href = `/asistencia.html?grupo=${grupoId}`;
        }

        // Ver tabla de asistencias
        function verTablaAsistencias() {
            window.location.href = `/tabla-asistencias.html?grupo=${grupoId}`;
        }

        // Ver historial
        function verHistorial() {
            window.location.href = `/historial.html?grupo=${grupoId}`;
        }

        // Ver ranking
        function verRanking() {
            window.location.href = `/ranking.html?grupo=${grupoId}`;
        }

        // Ver actividades
        function verActividades() {
            window.location.href = `/actividades.html?grupo=${grupoId}`;
        }

        // Ver insignias (sistema pr√≥ximamente)
        function verInsignias() {
            window.location.href = `/insignias.html`;
        }

        // ============================================
        // FUNCIONES DEL MODAL DE AJUSTE XP/HP
        // ============================================

        let tipoAjusteSeleccionado = null;

        // Abrir modal de ajuste XP para un alumno espec√≠fico
        function abrirModalAjusteXP(alumnoId, nombreCompleto, xp, hp) {
            tipoAjusteSeleccionado = null;

            // Establecer datos del alumno
            document.getElementById('ajuste-alumno-id').value = alumnoId;
            document.getElementById('ajuste-alumno-nombre').textContent = nombreCompleto;
            document.getElementById('ajuste-alumno-stats').textContent = `‚ö° ${xp} XP | ‚ù§Ô∏è ${hp} HP`;

            // Resetear selecciones
            document.getElementById('ajuste-cantidad').value = '10';
            document.getElementById('ajuste-observaciones').value = '';

            // Limpiar selecci√≥n de tipo
            document.querySelectorAll('#modal-ajuste-xp .modal-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            document.getElementById('modal-ajuste-xp').classList.add('active');
        }

        // Manejar selecci√≥n de tipo de ajuste
        document.querySelectorAll('#modal-ajuste-xp .modal-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#modal-ajuste-xp .modal-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                tipoAjusteSeleccionado = this.getAttribute('data-tipo-ajuste');
            });
        });

        // Confirmar ajuste de XP/HP
        async function confirmarAjusteXP() {
            const alumnoId = document.getElementById('ajuste-alumno-id').value;
            const cantidad = parseInt(document.getElementById('ajuste-cantidad').value);
            const motivo = document.getElementById('ajuste-motivo').value;
            const observaciones = document.getElementById('ajuste-observaciones').value;

            // Validaciones
            if (!alumnoId) {
                mostrarError('Error: No se pudo identificar al alumno');
                return;
            }

            if (!tipoAjusteSeleccionado) {
                mostrarError('Selecciona un tipo de ajuste');
                return;
            }

            if (!cantidad || cantidad <= 0) {
                mostrarError('La cantidad debe ser mayor a 0');
                return;
            }

            try {
                // Determinar endpoint y cantidad (positiva o negativa)
                const [tipo, signo] = tipoAjusteSeleccionado.split('-');
                const cantidadFinal = signo === 'positivo' ? cantidad : -cantidad;
                const endpoint = tipo === 'xp' ? 'ajustar-xp' : 'ajustar-hp';

                const response = await fetch(`${API_URL}/xp/alumno/${alumnoId}/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cantidad: cantidadFinal,
                        motivo,
                        observaciones: observaciones || undefined
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // üéÆ SONIDOS GAMING
                    if (tipo === 'xp') {
                        if (signo === 'positivo') {
                            // Sonido diferente seg√∫n cantidad de XP
                            reproducirSonido(cantidadFinal >= 100 ? 'xpBigGain' : 'xpGain');
                        } else {
                            reproducirSonido('xpLose');
                        }
                    } else if (tipo === 'hp') {
                        reproducirSonido(signo === 'positivo' ? 'hpGain' : 'hpLose');
                    }

                    const tipoTexto = tipo === 'xp' ? 'XP' : 'HP';
                    const accion = signo === 'positivo' ? 'otorgado' : 'descontado';
                    mostrarExito(`${tipoTexto} ${accion} exitosamente a ${data.data.alumno}`);
                    cerrarModal('ajuste-xp');

                    // Recargar datos del dashboard
                    await cargarDatos();
                } else {
                    reproducirSonido('error');
                    mostrarError(data.mensaje || 'Error al ajustar');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error de conexi√≥n con el servidor');
            }
        }

        // Cerrar modal al hacer clic fuera
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    const modalId = this.id.replace('modal-', '');
                    cerrarModal(modalId);
                }
            });
        });

        // ============================================
        // IMPORTACI√ìN DE PLICKERS üìÇ
        // ============================================

        // Variable global para almacenar puntos de la actividad
        let puntosTotalesActividad = null;

        // Abrir selector de archivo
        function abrirImportarPlickers() {
            // Primero pedir los puntos totales de la actividad
            const puntos = prompt('¬øCu√°ntos puntos vale esta actividad de Plickers?\n\nEjemplo: Si vale 20 puntos, escribe 20', '20');

            if (puntos === null) {
                // Usuario cancel√≥
                return;
            }

            const puntosNum = parseInt(puntos, 10);

            if (isNaN(puntosNum) || puntosNum <= 0 || puntosNum > 10000) {
                mostrarError('Por favor ingresa un n√∫mero v√°lido entre 1 y 10,000');
                return;
            }

            // Guardar los puntos totales
            puntosTotalesActividad = puntosNum;

            // Ahora s√≠ abrir el selector de archivo
            document.getElementById('input-csv-plickers').click();
        }

        // Procesar archivo CSV seleccionado
        async function procesarArchivoPlickers(event) {
            const archivo = event.target.files[0];

            if (!archivo) {
                return;
            }

            // Validar que tengamos los puntos totales
            if (!puntosTotalesActividad) {
                mostrarError('Error: No se especificaron los puntos de la actividad');
                return;
            }

            // Validar que sea un archivo CSV
            if (!archivo.name.endsWith('.csv')) {
                mostrarError('Por favor selecciona un archivo CSV v√°lido');
                puntosTotalesActividad = null; // Resetear
                return;
            }

            try {
                // Crear FormData para enviar el archivo
                const formData = new FormData();
                formData.append('archivo', archivo);
                formData.append('puntosTotales', puntosTotalesActividad);

                // Mostrar indicador de carga
                mostrarExito(`‚è≥ Procesando archivo CSV... (Actividad: ${puntosTotalesActividad} puntos)`);

                // Enviar al servidor
                const response = await fetch(`${API_URL}/importar/plickers`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // Mostrar resumen detallado
                    let mensaje = `‚úÖ Importaci√≥n completada:\n\n`;
                    mensaje += `üéØ Actividad: ${data.datos.puntosTotales} puntos totales\n`;
                    mensaje += `üìä Procesados: ${data.datos.procesados}\n`;
                    mensaje += `‚úì Actualizados: ${data.datos.actualizados}\n`;
                    mensaje += `‚úó Errores: ${data.datos.errores}\n`;

                    if (data.datos.noEncontrados.length > 0) {
                        mensaje += `\n‚ö†Ô∏è No encontrados (${data.datos.noEncontrados.length}):\n`;
                        data.datos.noEncontrados.forEach(alumno => {
                            mensaje += `  ‚Ä¢ ${alumno.nombre} (${alumno.score}% = ${alumno.puntosXP} pts)\n`;
                        });
                    }

                    alert(mensaje);
                    mostrarExito(`‚úÖ ${data.datos.actualizados} alumnos actualizados correctamente`);

                    // Recargar los datos del dashboard
                    await cargarDatos();
                } else {
                    mostrarError(data.mensaje || 'Error al importar el archivo');
                }
            } catch (error) {
                console.error('Error al importar Plickers:', error);
                mostrarError('Error de conexi√≥n con el servidor');
            } finally {
                // Limpiar el input file para permitir seleccionar el mismo archivo de nuevo
                event.target.value = '';
                // Resetear puntos totales
                puntosTotalesActividad = null;
            }
        }

        // Inicializar
        cargarDatos();
    </script>
</body>
</html>
